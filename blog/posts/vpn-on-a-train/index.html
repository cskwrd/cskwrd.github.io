<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>How to Build a Train Station One VPN at a Time</title>
		<meta name="description" content="Where curiosity crashes into technology, well, programming most of the time.">
		<link rel="alternate" href="feed/feed.xml" type="application/atom+xml" title="BlogFax">
		
		<style>/**
 * okaidia theme for JavaScript, CSS and HTML
 * Loosely based on Monokai textmate theme by http://www.monokai.nl/
 * @author ocodia
 */

code[class*="language-"],
pre[class*="language-"] {
	color: #f8f8f2;
	background: none;
	text-shadow: 0 1px rgba(0, 0, 0, 0.3);
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	font-size: 1em;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
	border-radius: 0.3em;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #272822;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: #8292a2;
}

.token.punctuation {
	color: #f8f8f2;
}

.token.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.constant,
.token.symbol,
.token.deleted {
	color: #f92672;
}

.token.boolean,
.token.number {
	color: #ae81ff;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #a6e22e;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string,
.token.variable {
	color: #f8f8f2;
}

.token.atrule,
.token.attr-value,
.token.function,
.token.class-name {
	color: #e6db74;
}

.token.keyword {
	color: #66d9ef;
}

.token.regex,
.token.important {
	color: #fd971f;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}
/*
 * New diff- syntax
 */

pre[class*="language-diff-"] {
	--eleventy-code-padding: 1.25em;
	padding-left: var(--eleventy-code-padding);
	padding-right: var(--eleventy-code-padding);
}
.token.deleted {
	background-color: hsl(0, 51%, 37%);
	color: inherit;
}
.token.inserted {
	background-color: hsl(126, 31%, 39%);
	color: inherit;
}

/* Make the + and - characters unselectable for copy/paste */
.token.prefix.unchanged,
.token.prefix.inserted,
.token.prefix.deleted {
	-webkit-user-select: none;
	user-select: none;
	display: inline-flex;
	align-items: center;
	justify-content: center;
	padding-top: 2px;
	padding-bottom: 2px;
}
.token.prefix.inserted,
.token.prefix.deleted {
	width: var(--eleventy-code-padding);
	background-color: rgba(0,0,0,.2);
}

/* Optional: full-width background color */
.token.inserted:not(.prefix),
.token.deleted:not(.prefix) {
	display: block;
	margin-left: calc(-1 * var(--eleventy-code-padding));
	margin-right: calc(-1 * var(--eleventy-code-padding));
	text-decoration: none; /* override del, ins, mark defaults */
	color: inherit; /* override del, ins, mark defaults */
}
/* This is an arbitrary CSS string added to the bundle */
/* Defaults */
:root {
	--font-family: -apple-system, system-ui, sans-serif;
	--font-family-monospace: Consolas, Menlo, Monaco, Andale Mono WT, Andale Mono, Lucida Console, Lucida Sans Typewriter, DejaVu Sans Mono, Bitstream Vera Sans Mono, Liberation Mono, Nimbus Mono L, Courier New, Courier, monospace;
}

/* Theme colors */
:root {
	--color-gray-20: #e0e0e0;
	--color-gray-50: #C0C0C0;
	--color-gray-90: #dad8d8;

	--background-color: #000;

	--text-color: var(--color-gray-90);
	--text-color-link: #0ff;
	--text-color-link-active: #0ff;
	--text-color-link-visited: #0aa;

	--syntax-tab-size: 2;
}

/* Media query for small screens */
@media (max-width: 600px) {
	.header-blocks:last-child {
		display: none;
	}
	.main-title {
		margin-right: 0;
	}
	.content {
		max-width: 90%;
	}
	.header-top {
		flex-direction: column;
		align-items: stretch;
	}
	.header-title {
		display: flex;
		justify-content: space-between;
	}
	.service-name {
		flex-grow: 1;
		text-align: right;
	}
	.header-date {
		margin-top: 5px;
		display: flex;
		justify-content: space-between;
	}
}


/* Global stylesheet */
* {
	box-sizing: border-box;
}

@view-transition {
	navigation: auto;
}

html,
body {
	padding: 0;
	margin: 0 auto;
	font-family: var(--font-family);
	color: var(--text-color);
	background-color: var(--background-color);
}
html {
	overflow-y: scroll;
}
body {
	max-width: 40em;
}

/* https://www.a11yproject.com/posts/how-to-hide-content/ */
.visually-hidden {
	clip: rect(0 0 0 0);
	clip-path: inset(50%);
	height: 1px;
	overflow: hidden;
	position: absolute;
	white-space: nowrap;
	width: 1px;
}

p:last-child {
	margin-bottom: 0;
}
p {
	line-height: 1.5;
}

li {
	line-height: 1.5;
}

a[href] {
	color: var(--text-color-link);
}
a[href]:visited {
	color: var(--text-color-link-visited);
}
a[href]:hover,
a[href]:active {
	color: var(--text-color-link-active);
}

.footer a {
	text-decoration: none;
	margin: 0 10px;
	font-weight: bold;
}
.footer a:hover { text-decoration: underline; }
.footer a.red { color: #f00; }
.footer a.green { color: #0f0; }
.footer a.yellow { color: #ff0; }
.footer a:visited.red { color: #a00; }
.footer a:visited.green { color: #0a0; }
.footer a:visited.yellow { color: #aa0; }
.footer a.blue { color: cornflowerblue; }

main,
footer {
	padding: 1rem;
}
footer {
	border-top: 2px solid cornflowerblue;
	display: flex;
	justify-content: center;
}
main :first-child {
	margin-top: 0;
}

header {
	border-bottom: 2px solid cornflowerblue;
}
header:after {
	content: "";
	display: table;
	clear: both;
}

.links-nextprev {
	display: flex;
	justify-content: space-between;
	gap: .5em 1em;
	list-style: "";
	border-top: 1px dashed var(--color-gray-20);
	padding: 1em 0;
}
.links-nextprev > * {
	flex-grow: 1;
}
.links-nextprev-next {
	text-align: right;
}

table {
	margin: 1em 0;
}
table td,
table th {
	padding-right: 1em;
}

pre,
code {
	font-family: var(--font-family-monospace);
}
pre:not([class*="language-"]) {
	margin: .5em 0;
	line-height: 1.375; /* 22px /16 */
	-moz-tab-size: var(--syntax-tab-size);
	-o-tab-size: var(--syntax-tab-size);
	tab-size: var(--syntax-tab-size);
	-webkit-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	overflow-x: auto;
}
code {
	word-break: break-all;
}

/* Header */
header {
	background-color: #000;
	padding: 10px;
}
.header-top {
	display: flex;
	justify-content: space-between;
	margin-bottom: 5px;
}
.header-title {
	font-size: 24px;
	font-weight: bold;
}
.header-main {
	display: flex;
	justify-content: center;
	align-items: center;
}
.header-blocks {
	display: flex;
}
.block {
	width: 30px;
	height: 30px;
	position: relative;
	margin: 0 2px;
}
.block::before {
	content: '';
	position: absolute;
	top: 5px;
	left: 5px;
	right: 5px;
	bottom: 5px;
	background-color: #000;
}
.block::after {
	content: '';
	position: absolute;
	top: 10px;
	left: 10px;
	right: 10px;
	bottom: 10px;
	background-color: inherit;
}
.block-red { background-color: #f00; }
.block-green { background-color: #0f0; }
.block-blue { background-color: #00f; }
.main-title {
	background-color: #0f0;
	color: #f00;
	padding: 5px 10px;
	font-size: 24px;
	font-weight: bold;
	text-align: center;
	flex-grow: 1;
	margin: 0 10px;
	max-width: 75%;
}

/* Nav */
.nav {
	display: flex;
	padding: 0;
	margin: 0;
	list-style: none;
}
.nav-item {
	display: inline-block;
	margin-right: 1em;
}
.nav-item a[href]:not(:hover) {
	text-decoration: none;
}
.nav a[href][aria-current="page"] {
	text-decoration: underline;
}

/* Posts list */
.postlist {
	list-style: none;
	padding: 0;
	padding-left: 1.5rem;
}
.postlist-item {
	display: flex;
	flex-wrap: wrap;
	align-items: baseline;
	counter-increment: start-from -1;
	margin-bottom: 1em;
}
.postlist-item:before {
	display: inline-block;
	pointer-events: none;
	content: "" counter(start-from, decimal-leading-zero) ". ";
	line-height: 100%;
	text-align: right;
	margin-left: -1.5rem;
}
.postlist-date,
.postlist-item:before {
	font-size: 0.8125em; /* 13px /16 */
	color: var(--color-gray-90);
}
.postlist-date {
	word-spacing: -0.5px;
}
.postlist-link {
	font-size: 1.1875em; /* 19px /16 */
	font-weight: 700;
	flex-basis: calc(100% - 1.5rem);
	padding-left: .25em;
	padding-right: .5em;
	text-underline-position: from-font;
	text-underline-offset: 0;
	text-decoration-thickness: 1px;
}
.postlist-item-active .postlist-link {
	font-weight: bold;
}

/* Tags */
.post-tag {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	text-transform: capitalize;
	font-style: italic;
}
.postlist-item > .post-tag {
	align-self: center;
}

/* Tags list */
.post-metadata {
	display: inline-flex;
	flex-wrap: wrap;
	gap: .5em;
	list-style: none;
	padding: 0;
	margin: 0;
}
.post-metadata time {
	margin-right: 1em;
}

/* Styles for when JavaScript is not available */
@media (min-width: 601px) {
	.no-js .header-top {
		flex-direction: row;
	}
}
.header-date {
	font-size: 18px;
	display: none; /* Hide by default, show with JS */
}
.header-date .time {
	color: #ff0;
}
.no-js .header-date {
	display: none !important;
}</style>
	</head>
	<body>
		<a href="#skip" class="visually-hidden">Skip to main content</a>

		<header>
			<div class="header-top">
				<div class="header-title">
					<span>P242</span>
					<span class="service-name">BLOGFAX</span>
				</div>
				
<div class="header-date" id="current-date"></div>

			</div>
			<div class="header-main">
				<div class="header-blocks">
					<div class="block block-red"></div>
					<div class="block block-green"></div>
					<div class="block block-blue"></div>
				</div>
				<div class="main-title">POST</div>
				<div class="header-blocks">
					<div class="block block-red"></div>
					<div class="block block-green"></div>
					<div class="block block-blue"></div>
				</div>
			</div>
		</header>

		<main id="skip">
			<heading-anchors>
				
<h1 id="how-to-build-a-train-station-one-vpn-at-a-time">How to Build a Train Station One VPN at a Time</h1>

<ul class="post-metadata">
	<li><time datetime="2023-07-01">01 July 2023</time></li>
	<li><a href="/blog/tags/ssh/" class="post-tag">ssh</a>, </li>
	<li><a href="/blog/tags/wireguard/" class="post-tag">wireguard</a>, </li>
	<li><a href="/blog/tags/docker/" class="post-tag">docker</a>, </li>
	<li><a href="/blog/tags/networking/" class="post-tag">networking</a>, </li>
	<li><a href="/blog/tags/linux/" class="post-tag">linux</a></li>
</ul>

<p>Like most of us in the software industry, I have a home lab set up at, well, home. In my lab I run various web services and tools for fun, for family, to learn, or for their utility. To save time and ensure my sanity in some cases, I use tools like Ansible, Docker, and in some cases even K3s. Today I am going to walk through installing <a href="https://www.flatcar.org/">Flatcar Container Linux</a> on a bare metal VPS, then configuring a WireGuard VPN server.</p>
<h2 id="things-you-ll-need">Things You'll Need</h2>
<ul>
<li>A bare metal VPS
<ul>
<li>This isn't a hard requirement, but this post is written with the assumption that you are using <s>someone else's computer</s> the ☁️.<br>
(I use this <a href="https://cloudfanatic.net/crm/aff.php?aff=582"><strong><em>SUPER</em></strong> cheap US host</a>)</li>
</ul>
</li>
<li>Flatcar Container Linux Installation Media
<ul>
<li><a href="https://stable.release.flatcar-linux.net/amd64-usr/current/">amd64</a></li>
<li><a href="https://stable.release.flatcar-linux.net/arm64-usr/current/">arm64</a></li>
</ul>
</li>
<li>Docker</li>
</ul>
<h2 id="pouring-the-foundation">Pouring the Foundation</h2>
<p>If you haven't worked with Flatcar Container Linux before, it will feel somewhat awkward. The strangest aspect of the distro is its lack of package manager. This is by design and actually what makes it rather nice to work with in the end. The only tools we will have at our disposal will be those need to run containers, and the idea is that anything else we need will come from a container.</p>
<p>As I mentioned, the idea behind Flatcar Container Linux is that all your dependencies come from containers. This affords us a unique opportunity to leverage this fact and provide all of our host during the installation process. There will be no installing tools or backing up configurations before we make changes. At this point, I would like to note that because VPS providers differ in the exact way in which they handle booting the OS installation media, I won't cover that particular aspect. I refer you to your provider's knowledge base and/or helpdesk.</p>
<p>Once we have booted the installation media, we can begin prepping the installation. To do this, we will be using the <a href="https://www.flatcar.org/docs/latest/provisioning/config-transpiler/configuration/">butane configuration specification</a> along with the <a href="https://quay.io/repository/coreos/butane?tab=tags&amp;tag=latest">butane config transpiler</a> container to create our host configuration. My VPS provider's interface to the live environment we are currently using, doesn't support copy and paste actions very well, so I will first create my configuration locally using a text editor and then transfer it to the VPS. If you prefer to work directly in the live environment, that is perfectly fine, as the <code>vim</code> editor is available. Copy the following butane config into your editor.</p>
<pre class="language-yaml" tabindex="0"><code class="language-yaml"><span class="token key atrule">variant</span><span class="token punctuation">:</span> flatcar
<span class="token key atrule">version</span><span class="token punctuation">:</span> 1.0.0
<span class="token key atrule">storage</span><span class="token punctuation">:</span>
  <span class="token key atrule">files</span><span class="token punctuation">:</span>
    <span class="token comment"># Set hostname</span>
    <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/hostname
      <span class="token key atrule">overwrite</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">mode</span><span class="token punctuation">:</span> <span class="token number">0644</span>      
      <span class="token key atrule">contents</span><span class="token punctuation">:</span>
        <span class="token key atrule">inline</span><span class="token punctuation">:</span> train<span class="token punctuation">-</span>station
    <span class="token comment"># Update sshd options, https://www.flatcar.org/docs/latest/setup/security/customizing-sshd/#customizing-sshd-with-a-butane-config</span>
    <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/ssh/sshd_config
      <span class="token key atrule">overwrite</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">mode</span><span class="token punctuation">:</span> <span class="token number">0600</span>
      <span class="token key atrule">contents</span><span class="token punctuation">:</span>
        <span class="token key atrule">inline</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          # Use most defaults for sshd configuration.
          UsePrivilegeSeparation sandbox
          Subsystem sftp internal-sftp
          UseDNS no</span>

          PermitRootLogin no
          AllowUsers core
          AuthenticationMethods publickey
    <span class="token comment"># Flatcar Container Linux doesn't set any firewall rules by default, so we define some here</span>
    <span class="token comment"># These rules start by blocking all incoming traffic and allowing all outgoing traffic</span>
    <span class="token comment"># Then loopback traffic is allowed</span>
    <span class="token comment"># Next existing connections are allowed, followed by allowing (incoming) traffic on port 22 (SSH)</span>
    <span class="token comment"># Finally various types of ICMP traffic is allowed, this traffic is useful for troubleshooting</span>
    <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /var/lib/iptables/rules<span class="token punctuation">-</span>save
      <span class="token key atrule">mode</span><span class="token punctuation">:</span> <span class="token number">0644</span>
      <span class="token key atrule">user</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> root
      <span class="token key atrule">group</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> root
      <span class="token key atrule">contents</span><span class="token punctuation">:</span>
        <span class="token key atrule">inline</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          *filter
          :INPUT DROP [0:0]
          :FORWARD DROP [0:0]
          :OUTPUT ACCEPT [0:0]
          -A INPUT -i lo -j ACCEPT
          -A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
          -A INPUT -p tcp -m tcp --dport 22 -j ACCEPT
          -A INPUT -p icmp -m icmp --icmp-type echo-reply -j ACCEPT
          -A INPUT -p icmp -m icmp --icmp-type destination-unreachable -j ACCEPT
          -A INPUT -p icmp -m icmp --icmp-type echo-request -j ACCEPT
          -A INPUT -p icmp -m icmp --icmp-type time-exceeded -j ACCEPT
          COMMIT</span>
<span class="token key atrule">systemd</span><span class="token punctuation">:</span>
  <span class="token key atrule">units</span><span class="token punctuation">:</span>
    <span class="token comment"># Ensure that our default firewall rules are read in at boot time</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> iptables<span class="token punctuation">-</span>restore.service
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment"># Ensure Docker starts automatically instead of being only socket-activated</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> docker.service
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">passwd</span><span class="token punctuation">:</span>
  <span class="token key atrule">users</span><span class="token punctuation">:</span>
    <span class="token comment"># This is the default user in a Flatcar Container Linux installation</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> core
      <span class="token key atrule">ssh_authorized_keys</span><span class="token punctuation">:</span>
        <span class="token comment"># A list of public keys you wish to use for key auth go here</span>
        <span class="token punctuation">-</span> ssh<span class="token punctuation">-</span>ed25519 AAAAC3NzaC1lZDI1NTE5AAAAINZCBaBv4Pel8Xf6aBhufccXj2x+R2il7Jri1hICHkHk cskwrd@blog
</code></pre>
<p>Don't forget to update the <code>ssh_authorized_keys</code> authorized with the correct keys. After the installation process has completed, the only way to log in will be via SSH. Additionally, you can update the hostname to something more suitable for you.
After you are finished modifying the file, save it. I chose to save mine as <code>train-station.bu</code>.</p>
<p>With a butane config in hand, it is time to transpile it into an ignition config. This process is straight forward, and can be done using the following one-liner: <code>cat train-station.bu | docker run --rm -i quay.io/coreos/butane:latest &gt; train-station.ign</code>. It should take less than a minute to complete successfully. At this point, if you have been working locally, you need to transfer the <code>train-station.ign</code> ignition config to the VPS. I did this by copying the config using <code>scp</code>.</p>
<p>The last step of the installation process is almost as simple as a single command. We just need to look up one last piece of information, the path to the disk we want to use. We will use <code>lsblk</code> to help us in our quest for a disk path.</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">$ lsblk
NAME    MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINTS
sr0      <span class="token number">11</span>:0    <span class="token number">1</span>   353M  <span class="token number">0</span> rom
vda     <span class="token number">253</span>:0    <span class="token number">0</span>   200G  <span class="token number">0</span> disk
`-vda1  <span class="token number">253</span>:1    <span class="token number">0</span> <span class="token number">197</span>.7G  <span class="token number">0</span> part  /</code></pre>
<p>Your output will likely be a tad different, but you are looking for a line item of <code>TYPE</code> <code>disk</code> and a <code>SIZE</code> that matches the disk size you want to install the OS on. In the output above, the path I want is <code>/dev/vda</code>. With the disk path in hand, it is time to execute the installer. To do this, we invoke <code>sudo flatcar-install -d /dev/vda -i ./train-station.ign</code>. The process doesn't take long to complete. Once the installation is complete, reboot and be sure that you are now running from the disk and not the installation media. An easy test can be performed by attempting to connect via SSH, if that succeeds you can move on to Docker and WireGuard, otherwise do a quick cry and repeat the process outlined above.</p>
<h2 id="building-the-rest-of-the-station">Building the Rest of the Station</h2>
<p>From here on we will move pretty quick. We will use the <a href="https://docs.linuxserver.io/images/docker-wireguard">linuxserver/wireguard</a> container for our WireGuard server. To get started, save the following Compose file somewhere your local Docker client can access with the name <code>docker-compose.yml</code>.</p>
<pre class="language-yaml" tabindex="0"><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3.4'</span>

<span class="token key atrule">networks</span><span class="token punctuation">:</span>
  <span class="token key atrule">wgnet</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> wgnet
    <span class="token key atrule">driver</span><span class="token punctuation">:</span> bridge
    <span class="token key atrule">ipam</span><span class="token punctuation">:</span>
     <span class="token key atrule">config</span><span class="token punctuation">:</span>
       <span class="token punctuation">-</span> <span class="token key atrule">subnet</span><span class="token punctuation">:</span> 10.123.0.0/16
         <span class="token key atrule">gateway</span><span class="token punctuation">:</span> 10.123.0.1

<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">wireguard</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> lscr.io/linuxserver/wireguard<span class="token punctuation">:</span>latest
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> wireguard
    <span class="token key atrule">cap_add</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> NET_ADMIN
      <span class="token punctuation">-</span> SYS_MODULE
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> PUID=$<span class="token punctuation">{</span>PUID<span class="token punctuation">:</span><span class="token punctuation">?</span>UID required<span class="token punctuation">}</span>
      <span class="token punctuation">-</span> PGID=$<span class="token punctuation">{</span>PGID<span class="token punctuation">:</span><span class="token punctuation">?</span>GID required<span class="token punctuation">}</span>
      <span class="token punctuation">-</span> TZ=$<span class="token punctuation">{</span>TZ<span class="token punctuation">:</span><span class="token punctuation">-</span>Etc/UTC<span class="token punctuation">}</span>
      <span class="token punctuation">-</span> SERVERURL=$<span class="token punctuation">{</span>WG_SERVER_URL<span class="token punctuation">:</span><span class="token punctuation">?</span>WireGuard server URL required<span class="token punctuation">}</span>
      <span class="token punctuation">-</span> SERVERPORT=$<span class="token punctuation">{</span>WG_SERVER_PORT<span class="token punctuation">:</span><span class="token number">-51820</span><span class="token punctuation">}</span>
      <span class="token punctuation">-</span> PEERS=$<span class="token punctuation">{</span>WG_PEER_LIST<span class="token punctuation">:</span><span class="token punctuation">?</span>WireGuard peer list required<span class="token punctuation">}</span>
      <span class="token punctuation">-</span> PEERDNS=1.1.1.1
      <span class="token punctuation">-</span> INTERNAL_SUBNET=$<span class="token punctuation">{</span>WG_INTERNAL_SUBNET<span class="token punctuation">:</span><span class="token punctuation">?</span>WireGuard subnet required<span class="token punctuation">}</span>
      <span class="token punctuation">-</span> ALLOWEDIPS=0.0.0.0/0
      <span class="token punctuation">-</span> PERSISTENTKEEPALIVE_PEERS=$<span class="token punctuation">{</span>WG_PKA_PEER_LIST<span class="token punctuation">}</span>
      <span class="token punctuation">-</span> LOG_CONFS=true <span class="token comment"># log client config to logs as QR codes</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> wgnet
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> wg<span class="token punctuation">-</span>data<span class="token punctuation">:</span>/config
      <span class="token punctuation">-</span> /lib/modules<span class="token punctuation">:</span>/lib/modules
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"${WG_SERVER_PORT:-51820}:51820/udp"</span>
    <span class="token key atrule">sysctls</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> net.ipv4.conf.all.src_valid_mark=1

<span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token key atrule">wg-data</span><span class="token punctuation">:</span>
</code></pre>
<p>After saving any modification need to fit your network, save a new file named <code>.env</code> in the same directory as the compose file with the following contents.</p>
<pre><code># General linuxserver.io env vars
PGID=500
PUID=500

# Required WireGuard container env vars
WG_PEER_LIST=thomas,emily
WG_INTERNAL_SUBNET=10.210.0.0
WG_PKA_PEER_LIST=

# Optional WireGuard container env variables
#WG_SERVER_PORT=43210

</code></pre>
<p>The <code>.env</code> file will be parsed when we invoke the <code>docker compose</code> command and the variable values will be injected into the resulting compose spec. Double-check the values in the <code>.env</code> file and invoke <code>docker compose -H ssh://core@&lt;train-station-ip&gt; -f docker-compose.yml up -d</code>. Here we use the <code>-H</code> flag to set the Docker endpoint to use. This will securely wrap all communication between the Docker daemon on the VPS and the Docker client we have installed locally. If this is the first time you have made an SSH connection to your VPS, the invocation will fail because the VPS's host key has not yet been trusted yet. The easiest way to fix the issue is to connect to the VPS of SSH before invoking the <code>docker compose</code> command. Now it's time for the grand opening of this <a href="https://en.wikipedia.org/wiki/Shining_Time_Station">shining time station</a>!</p>
<h2 id="open-for-business">Open for Business</h2>
<p>Now that we have the operating system installed and the WireGuard server running in a container, we can begin to enjoy the fruits of our labor. My primary WireGuard use case is connecting back to services in my home lab from my phone while on the move. That sort of configuration is worthy of a post by itself, so for now we'll focus on getting an Android phone connected. The maintainers of the WireGuard project have really put in some work on this app. Start by opening the app and tapping the add button. Tap the <code>Scan from QR code</code> option. In your terminal, invoke the following <code>docker -H ssh://core@&lt;train-station-ip&gt; logs wireguard</code> and you should see a few QR codes (the config above configures 2 peers). Scan the code for <code>peer_thomas</code>. After a successful scan, you are prompted to name the tunnel. Keeping with the post's theme, I named the tunnel <code>train-station</code>. Finally, activate the tunnel by tapping the toggle button.</p>
<h2 id="next-stop-web-scale">Next Stop, WEB SCALE!</h2>
<p>Not really, this setup isn't built for that! As I stated before, the plan is to make some of my self-hosted services available over WireGuard, but that's a post for a different day. Thanks for reading!</p>

<ul class="links-nextprev"><li class="links-nextprev-prev">← Previous<br> <a href="/blog/posts/automatic-resume-engine/">My Automatic Resume Engine</a></li><li class="links-nextprev-next">Next →<br><a href="/blog/posts/risc-v-new-kid-on-the-chip/">RISC-V: The New Kid on the Chip</a></li>
</ul>

			</heading-anchors>
		</main>

		<footer class="footer">
			<a class="red" href="/about">About</a>
			<a class="green" href="/blog/archive/">Archive</a>
			<a class="yellow" href="https://github.com/cskwrd">GitHub</a>
			<a class="blue" href="/blog/feed.xml">Hungry?</a>
		</footer>

		<!-- This page `/blog/posts/vpn-on-a-train/` was built on 2025-12-26T03:01:25.905Z -->
		<script type="module" src="/dist/oW-85j5Pwo.js"></script>
	</body>
</html>
