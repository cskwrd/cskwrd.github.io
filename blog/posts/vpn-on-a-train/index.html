<!DOCTYPE html>
<html lang="en-US">
<head>
  <script src="https://cskwrd.github.io/theme.min.js" integrity="sha384-IpIaa84kOKgkF5EJ0fD/kBe2wtIIsIB60ANGmuJxeA0dz5bSRfwBwp2/QybtQpU2"></script>
  <link rel="stylesheet" href="https://cskwrd.github.io/abridge-blue-switcher.css?h=ba62bd394ace4fb2b143" />
  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <script defer src="https://cskwrd.github.io/search_index.en.js?h=fb89b102e3d54713adc7" integrity="sha384-e9lgfxawTnSgSQVrVlUcVjECdaZ9B/YRWG7n4t2y+mWLbpgdK93aP1VFdietcPZt"></script>
  <script defer src="https://cskwrd.github.io/abridge-bundle-nofacade.min.js?h=9bcf621a2fcab7336017" integrity="sha384-u8AROOUG6n2Xjk2+7pvkkfeSIqinjI1tmqeBpZRlZtc5KFO/8DyFfEir6fAE2wcq"></script>
  <meta name="base" content="https://cskwrd.github.io" />
  <link rel="alternate" type="application/atom+xml" title="Atom/RSS Feed" href="https://cskwrd.github.io/atom.xml" />
  <meta name="robots" content="index, follow" />
  <meta name="googlebot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
  <meta name="bingbot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
  <title>How to Build a Train Station One VPN at a Time | A Blog</title>
  <meta name="author" content="cskwrd" />
  <meta name="copyright" content="A Blog" />
  <meta name="description" content="Where curiosity crashes into technology, well, programming most of the time." />
  <link rel="canonical" href="https://cskwrd.github.io/blog/posts/vpn-on-a-train/" />
  <meta name="keywords" content="Blog, Software, DevOps, Technical, Semantic Html, Fast, lightweight" />
  <meta property="og:url" content="https://cskwrd.github.io/blog/posts/vpn-on-a-train/" />
  <meta name="twitter:url" content="https://cskwrd.github.io/blog/posts/vpn-on-a-train/" />
  <meta property="og:description" content="Where curiosity crashes into technology, well, programming most of the time." />
  <meta name="twitter:description" content="Where curiosity crashes into technology, well, programming most of the time." />
  <meta property="og:title" content="How to Build a Train Station One VPN at a Time | A Blog" />
  <meta name="twitter:title" content="How to Build a Train Station One VPN at a Time | A Blog" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:image" content="https://cskwrd.github.io/banner.png" />
  <meta property="og:image" content="https://cskwrd.github.io/banner.png" />
  <meta property="og:site_name" content="A Blog" />
  <meta property="og:locale" content="en_US" />
  <meta property="og:type" content="website" />
  <meta property="og:updated_time" content="2023-07-01" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="theme-color" content="#333333" />
  <meta name="msapplication-TileColor" content="#333333" />
  <link rel="manifest" href="https://cskwrd.github.io/site.webmanifest" />
  <link rel="mask-icon" href="https://cskwrd.github.io/safari-pinned-tab.svg" color="#ff9900" />
  <link rel="apple-touch-icon" sizes="180x180" href="https://cskwrd.github.io/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="https://cskwrd.github.io/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="https://cskwrd.github.io/favicon-16x16.png" />
  <noscript><link rel="stylesheet" href="https://cskwrd.github.io/nojs.css" /></noscript>
</head>
<body>
  <header>
    <nav>
      <div><h1><a href="https://cskwrd.github.io/"><svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="#f90" viewBox="0 0 96 96" width="32" height="32"><path stroke-width="14" d="M14 99 46 7h4l32 92"/><path stroke-width="9" d="M-3 82c43-26 59-26 102 0"/><path stroke-linecap="round" stroke-width="1.5" d="M94 72v7m-5-9.8v7m-5-9.8v7.1M79 64v7M63 57.7v7m-5-8.2v7m-5-7.8v7m-5-7.2v7m-5-6.7v7m-5-6.3v7m-5-5.8v7M17 64v7m-5-4.6v7m-5-4.2v7M2 72v7"/></svg>blog</a></h1></div>
      <div>
        <ul><li> <h2><a href="https://cskwrd.github.io/blog/posts/">Posts</a></h2> </li><li class="js"><i type="reset" id="mode" class="svgs adjust"></i></li></ul>
      </div>
      <div>
        <form autocomplete=off class="js" name="goSearch" id="searchbox">
          <div class="searchd">
            <input id="searchinput" type="text" placeholder="Search" title="Search" />
            <button type="submit" title="Search"><i class="svgs search"></i></button>
          </div>
          <div><div id="suggestions"></div></div>
        </form>
      </div>
    </nav>
  </header>
  <main>
    <article>
        <h1><a href="https://cskwrd.github.io/blog/posts/vpn-on-a-train/">How to Build a Train Station One VPN at a Time</a></h1>
        <span class="s95"> cskwrd<span class="hpad"> </span> July 01, 2023<span class="hpad"> </span> [<a href="https://cskwrd.github.io/categories/project/">Project</a>] #<a href="https://cskwrd.github.io/tags/ssh/">ssh</a>  #<a href="https://cskwrd.github.io/tags/wireguard/">wireguard</a>  #<a href="https://cskwrd.github.io/tags/docker/">docker</a>  #<a href="https://cskwrd.github.io/tags/networking/">networking</a>  #<a href="https://cskwrd.github.io/tags/linux/">linux</a> </span>

    <p>Like most of us in the software industry, I have a home lab set up at, well, home. In my lab I run various web services and tools for fun, for family, to learn, or for their utility. To save time and ensure my sanity in some cases, I use tools like Ansible, Docker, and in some cases even K3s. Today I am going to walk through installing <a rel="noopener nofollow" target="_blank" href="https://www.flatcar.org/">Flatcar Container Linux</a> on a bare metal VPS, then configuring a WireGuard VPN server.</p>
<h2 id="things-you-ll-need">Things You'll Need</h2>
<ul>
<li>A bare metal VPS
<ul>
<li>This isn't a hard requirement, but this post is written with the assumption that you are using <del>someone else's computer</del> the ☁️.<br />
(I use this <a rel="noopener nofollow" target="_blank" href="https://cloudfanatic.net/crm/aff.php?aff=582"><strong><em>SUPER</em></strong> cheap US host</a>)</li>
</ul>
</li>
<li>Flatcar Container Linux Installation Media
<ul>
<li><a rel="noopener nofollow" target="_blank" href="https://stable.release.flatcar-linux.net/amd64-usr/current/">amd64</a></li>
<li><a rel="noopener nofollow" target="_blank" href="https://stable.release.flatcar-linux.net/arm64-usr/current/">arm64</a></li>
</ul>
</li>
<li>Docker</li>
</ul>
<h2 id="pouring-the-foundation">Pouring the Foundation</h2>
<p>If you haven't worked with Flatcar Container Linux before, it will feel somewhat awkward. The strangest aspect of the distro is its lack of package manager. This is by design and actually what makes it rather nice to work with in the end. The only tools we will have at our disposal will be those need to run containers, and the idea is that anything else we need will come from a container.</p>
<p>As I mentioned, the idea behind Flatcar Container Linux is that all your dependencies come from containers. This affords us a unique opportunity to leverage this fact and provide all of our host during the installation process. There will be no installing tools or backing up configurations before we make changes. At this point, I would like to note that because VPS providers differ in the exact way in which they handle booting the OS installation media, I won't cover that particular aspect. I refer you to your provider's knowledge base and/or helpdesk.</p>
<p>Once we have booted the installation media, we can begin prepping the installation. To do this, we will be using the <a rel="noopener nofollow" target="_blank" href="https://www.flatcar.org/docs/latest/provisioning/config-transpiler/configuration/">butane configuration specification</a> along with the <a rel="noopener nofollow" target="_blank" href="https://quay.io/repository/coreos/butane?tab=tags&amp;tag=latest">butane config transpiler</a> container to create our host configuration. My VPS provider's interface to the live environment we are currently using, doesn't support copy and paste actions very well, so I will first create my configuration locally using a text editor and then transfer it to the VPS. If you prefer to work directly in the live environment, that is perfectly fine, as the <code>vim</code> editor is available. Copy the following butane config into your editor.</p>
<pre data-lang="yaml" class="language-yaml z-code"><code class="language-yaml" data-lang="yaml"><span class="z-source z-yaml"><span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">variant</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">flatcar</span>
</span><span class="z-source z-yaml"><span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">version</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-constant z-numeric z-float z-decimal z-yaml">1<span class="z-punctuation z-separator z-decimal z-yaml">.</span>0.0</span>
</span><span class="z-source z-yaml"><span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">storage</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
</span><span class="z-source z-yaml">  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">files</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
</span><span class="z-source z-yaml">    <span class="z-comment z-line z-number-sign z-yaml"><span class="z-punctuation z-definition z-comment z-line z-number-sign z-yaml">#</span> Set hostname
</span></span><span class="z-source z-yaml">    <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">path</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">/etc/hostname</span>
</span><span class="z-source z-yaml">      <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">overwrite</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-constant z-language z-boolean z-yaml">true</span>
</span><span class="z-source z-yaml">      <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">mode</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-constant z-numeric z-integer z-octal z-yaml"><span class="z-punctuation z-definition z-numeric z-base z-yaml">0</span>644</span>      
</span><span class="z-source z-yaml">      <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">contents</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
</span><span class="z-source z-yaml">        <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">inline</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">train-station</span>
</span><span class="z-source z-yaml">    <span class="z-comment z-line z-number-sign z-yaml"><span class="z-punctuation z-definition z-comment z-line z-number-sign z-yaml">#</span> Update sshd options, https://www.flatcar.org/docs/latest/setup/security/customizing-sshd/#customizing-sshd-with-a-butane-config
</span></span><span class="z-source z-yaml">    <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">path</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">/etc/ssh/sshd_config</span>
</span><span class="z-source z-yaml">      <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">overwrite</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-constant z-language z-boolean z-yaml">true</span>
</span><span class="z-source z-yaml">      <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">mode</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-constant z-numeric z-integer z-octal z-yaml"><span class="z-punctuation z-definition z-numeric z-base z-yaml">0</span>600</span>
</span><span class="z-source z-yaml">      <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">contents</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
</span><span class="z-source z-yaml">        <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">inline</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-keyword z-control z-flow z-block-scalar z-literal z-yaml">|</span>
</span><span class="z-source z-yaml"><span class="z-string z-unquoted z-block z-yaml">          # Use most defaults for sshd configuration.
</span></span><span class="z-source z-yaml"><span class="z-string z-unquoted z-block z-yaml">          UsePrivilegeSeparation sandbox
</span></span><span class="z-source z-yaml"><span class="z-string z-unquoted z-block z-yaml">          Subsystem sftp internal-sftp
</span></span><span class="z-source z-yaml"><span class="z-string z-unquoted z-block z-yaml">          UseDNS no
</span></span><span class="z-source z-yaml"><span class="z-string z-unquoted z-block z-yaml">
</span></span><span class="z-source z-yaml"><span class="z-string z-unquoted z-block z-yaml">          PermitRootLogin no
</span></span><span class="z-source z-yaml"><span class="z-string z-unquoted z-block z-yaml">          AllowUsers core
</span></span><span class="z-source z-yaml"><span class="z-string z-unquoted z-block z-yaml">          AuthenticationMethods publickey
</span></span><span class="z-source z-yaml"><span class="z-string z-unquoted z-block z-yaml"></span>    <span class="z-comment z-line z-number-sign z-yaml"><span class="z-punctuation z-definition z-comment z-line z-number-sign z-yaml">#</span> Flatcar Container Linux doesn&#39;t set any firewall rules by default, so we define some here
</span></span><span class="z-source z-yaml">    <span class="z-comment z-line z-number-sign z-yaml"><span class="z-punctuation z-definition z-comment z-line z-number-sign z-yaml">#</span> These rules start by blocking all incoming traffic and allowing all outgoing traffic
</span></span><span class="z-source z-yaml">    <span class="z-comment z-line z-number-sign z-yaml"><span class="z-punctuation z-definition z-comment z-line z-number-sign z-yaml">#</span> Then loopback traffic is allowed
</span></span><span class="z-source z-yaml">    <span class="z-comment z-line z-number-sign z-yaml"><span class="z-punctuation z-definition z-comment z-line z-number-sign z-yaml">#</span> Next existing connections are allowed, followed by allowing (incoming) traffic on port 22 (SSH)
</span></span><span class="z-source z-yaml">    <span class="z-comment z-line z-number-sign z-yaml"><span class="z-punctuation z-definition z-comment z-line z-number-sign z-yaml">#</span> Finally various types of ICMP traffic is allowed, this traffic is useful for troubleshooting
</span></span><span class="z-source z-yaml">    <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">path</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">/var/lib/iptables/rules-save</span>
</span><span class="z-source z-yaml">      <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">mode</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-constant z-numeric z-integer z-octal z-yaml"><span class="z-punctuation z-definition z-numeric z-base z-yaml">0</span>644</span>
</span><span class="z-source z-yaml">      <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">user</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
</span><span class="z-source z-yaml">        <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">name</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">root</span>
</span><span class="z-source z-yaml">      <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">group</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
</span><span class="z-source z-yaml">        <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">name</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">root</span>
</span><span class="z-source z-yaml">      <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">contents</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
</span><span class="z-source z-yaml">        <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">inline</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-keyword z-control z-flow z-block-scalar z-literal z-yaml">|</span>
</span><span class="z-source z-yaml"><span class="z-string z-unquoted z-block z-yaml">          *filter
</span></span><span class="z-source z-yaml"><span class="z-string z-unquoted z-block z-yaml">          :INPUT DROP [0:0]
</span></span><span class="z-source z-yaml"><span class="z-string z-unquoted z-block z-yaml">          :FORWARD DROP [0:0]
</span></span><span class="z-source z-yaml"><span class="z-string z-unquoted z-block z-yaml">          :OUTPUT ACCEPT [0:0]
</span></span><span class="z-source z-yaml"><span class="z-string z-unquoted z-block z-yaml">          -A INPUT -i lo -j ACCEPT
</span></span><span class="z-source z-yaml"><span class="z-string z-unquoted z-block z-yaml">          -A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
</span></span><span class="z-source z-yaml"><span class="z-string z-unquoted z-block z-yaml">          -A INPUT -p tcp -m tcp --dport 22 -j ACCEPT
</span></span><span class="z-source z-yaml"><span class="z-string z-unquoted z-block z-yaml">          -A INPUT -p icmp -m icmp --icmp-type echo-reply -j ACCEPT
</span></span><span class="z-source z-yaml"><span class="z-string z-unquoted z-block z-yaml">          -A INPUT -p icmp -m icmp --icmp-type destination-unreachable -j ACCEPT
</span></span><span class="z-source z-yaml"><span class="z-string z-unquoted z-block z-yaml">          -A INPUT -p icmp -m icmp --icmp-type echo-request -j ACCEPT
</span></span><span class="z-source z-yaml"><span class="z-string z-unquoted z-block z-yaml">          -A INPUT -p icmp -m icmp --icmp-type time-exceeded -j ACCEPT
</span></span><span class="z-source z-yaml"><span class="z-string z-unquoted z-block z-yaml">          COMMIT
</span></span><span class="z-source z-yaml"><span class="z-string z-unquoted z-block z-yaml"></span><span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">systemd</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
</span><span class="z-source z-yaml">  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">units</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
</span><span class="z-source z-yaml">    <span class="z-comment z-line z-number-sign z-yaml"><span class="z-punctuation z-definition z-comment z-line z-number-sign z-yaml">#</span> Ensure that our default firewall rules are read in at boot time
</span></span><span class="z-source z-yaml">    <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">name</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">iptables-restore.service</span>
</span><span class="z-source z-yaml">      <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">enabled</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-constant z-language z-boolean z-yaml">true</span>
</span><span class="z-source z-yaml">    <span class="z-comment z-line z-number-sign z-yaml"><span class="z-punctuation z-definition z-comment z-line z-number-sign z-yaml">#</span> Ensure Docker starts automatically instead of being only socket-activated
</span></span><span class="z-source z-yaml">    <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">name</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">docker.service</span>
</span><span class="z-source z-yaml">      <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">enabled</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-constant z-language z-boolean z-yaml">true</span>
</span><span class="z-source z-yaml"><span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">passwd</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
</span><span class="z-source z-yaml">  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">users</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
</span><span class="z-source z-yaml">    <span class="z-comment z-line z-number-sign z-yaml"><span class="z-punctuation z-definition z-comment z-line z-number-sign z-yaml">#</span> This is the default user in a Flatcar Container Linux installation
</span></span><span class="z-source z-yaml">    <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">name</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">core</span>
</span><span class="z-source z-yaml">      <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">ssh_authorized_keys</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
</span><span class="z-source z-yaml">        <span class="z-comment z-line z-number-sign z-yaml"><span class="z-punctuation z-definition z-comment z-line z-number-sign z-yaml">#</span> A list of public keys you wish to use for key auth go here
</span></span><span class="z-source z-yaml">        <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml">ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAINZCBaBv4Pel8Xf6aBhufccXj2x+R2il7Jri1hICHkHk cskwrd@blog</span>
</span><span class="z-source z-yaml">
</span></code></pre>
<p>Don't forget to update the <code>ssh_authorized_keys</code> authorized with the correct keys. After the installation process has completed, the only way to log in will be via SSH. Additionally, you can update the hostname to something more suitable for you.
After you are finished modifying the file, save it. I chose to save mine as <code>train-station.bu</code>.</p>
<p>With a butane config in hand, it is time to transpile it into an ignition config. This process is straight forward, and can be done using the following one-liner: <code>cat train-station.bu | docker run --rm -i quay.io/coreos/butane:latest &gt; train-station.ign</code>. It should take less than a minute to complete successfully. At this point, if you have been working locally, you need to transfer the <code>train-station.ign</code> ignition config to the VPS. I did this by copying the config using <code>scp</code>.</p>
<p>The last step of the installation process is almost as simple as a single command. We just need to look up one last piece of information, the path to the disk we want to use. We will use <code>lsblk</code> to help us in our quest for a disk path.</p>
<pre data-lang="shell" class="language-shell z-code"><code class="language-shell" data-lang="shell"><span class="z-text z-plain">$ lsblk
</span><span class="z-text z-plain">NAME    MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINTS
</span><span class="z-text z-plain">sr0      11:0    1   353M  0 rom
</span><span class="z-text z-plain">vda     253:0    0   200G  0 disk
</span><span class="z-text z-plain">`-vda1  253:1    0 197.7G  0 part  /
</span></code></pre>
<p>Your output will likely be a tad different, but you are looking for a line item of <code>TYPE</code> <code>disk</code> and a <code>SIZE</code> that matches the disk size you want to install the OS on. In the output above, the path I want is <code>/dev/vda</code>. With the disk path in hand, it is time to execute the installer. To do this, we invoke <code>sudo flatcar-install -d /dev/vda -i ./train-station.ign</code>. The process doesn't take long to complete. Once the installation is complete, reboot and be sure that you are now running from the disk and not the installation media. An easy test can be performed by attempting to connect via SSH, if that succeeds you can move on to Docker and WireGuard, otherwise do a quick cry and repeat the process outlined above.</p>
<h2 id="building-the-rest-of-the-station">Building the Rest of the Station</h2>
<p>From here on we will move pretty quick. We will use the <a rel="noopener nofollow" target="_blank" href="https://docs.linuxserver.io/images/docker-wireguard">linuxserver/wireguard</a> container for our WireGuard server. To get started, save the following Compose file somewhere your local Docker client can access with the name <code>docker-compose.yml</code>.</p>
<pre data-lang="yaml" class="language-yaml z-code"><code class="language-yaml" data-lang="yaml"><span class="z-source z-yaml"><span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">version</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-quoted z-single z-yaml"><span class="z-punctuation z-definition z-string z-begin z-yaml">&#39;</span>3.4<span class="z-punctuation z-definition z-string z-end z-yaml">&#39;</span></span>
</span><span class="z-source z-yaml">
</span><span class="z-source z-yaml"><span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">networks</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
</span><span class="z-source z-yaml">  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">wgnet</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
</span><span class="z-source z-yaml">    <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">name</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">wgnet</span>
</span><span class="z-source z-yaml">    <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">driver</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">bridge</span>
</span><span class="z-source z-yaml">    <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">ipam</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
</span><span class="z-source z-yaml">     <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">config</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
</span><span class="z-source z-yaml">       <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">subnet</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">10.123.0.0/16</span>
</span><span class="z-source z-yaml">         <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">gateway</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-constant z-numeric z-float z-decimal z-yaml">10<span class="z-punctuation z-separator z-decimal z-yaml">.</span>123.0.1</span>
</span><span class="z-source z-yaml">
</span><span class="z-source z-yaml"><span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">services</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
</span><span class="z-source z-yaml">  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">wireguard</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
</span><span class="z-source z-yaml">    <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">image</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">lscr.io/linuxserver/wireguard:latest</span>
</span><span class="z-source z-yaml">    <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">container_name</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">wireguard</span>
</span><span class="z-source z-yaml">    <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">cap_add</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
</span><span class="z-source z-yaml">      <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml">NET_ADMIN</span>
</span><span class="z-source z-yaml">      <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml">SYS_MODULE</span>
</span><span class="z-source z-yaml">    <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">environment</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
</span><span class="z-source z-yaml">      <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml">PUID=${PUID:?UID required}</span>
</span><span class="z-source z-yaml">      <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml">PGID=${PGID:?GID required}</span>
</span><span class="z-source z-yaml">      <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml">TZ=${TZ:-Etc/UTC}</span>
</span><span class="z-source z-yaml">      <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml">SERVERURL=${WG_SERVER_URL:?WireGuard server URL required}</span>
</span><span class="z-source z-yaml">      <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml">SERVERPORT=${WG_SERVER_PORT:-51820}</span>
</span><span class="z-source z-yaml">      <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml">PEERS=${WG_PEER_LIST:?WireGuard peer list required}</span>
</span><span class="z-source z-yaml">      <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml">PEERDNS=1.1.1.1</span>
</span><span class="z-source z-yaml">      <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml">INTERNAL_SUBNET=${WG_INTERNAL_SUBNET:?WireGuard subnet required}</span>
</span><span class="z-source z-yaml">      <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml">ALLOWEDIPS=0.0.0.0/0</span>
</span><span class="z-source z-yaml">      <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml">PERSISTENTKEEPALIVE_PEERS=${WG_PKA_PEER_LIST}</span>
</span><span class="z-source z-yaml">      <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml">LOG_CONFS=true</span> <span class="z-comment z-line z-number-sign z-yaml"><span class="z-punctuation z-definition z-comment z-line z-number-sign z-yaml">#</span> log client config to logs as QR codes
</span></span><span class="z-source z-yaml">    <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">networks</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
</span><span class="z-source z-yaml">      <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml">wgnet</span>
</span><span class="z-source z-yaml">    <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">volumes</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
</span><span class="z-source z-yaml">      <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml">wg-data:/config</span>
</span><span class="z-source z-yaml">      <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml">/lib/modules:/lib/modules</span>
</span><span class="z-source z-yaml">    <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">ports</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
</span><span class="z-source z-yaml">      <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-quoted z-double z-yaml"><span class="z-punctuation z-definition z-string z-begin z-yaml">&quot;</span>${WG_SERVER_PORT:-51820}:51820/udp<span class="z-punctuation z-definition z-string z-end z-yaml">&quot;</span></span>
</span><span class="z-source z-yaml">    <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">sysctls</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
</span><span class="z-source z-yaml">      <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml">net.ipv4.conf.all.src_valid_mark=1</span>
</span><span class="z-source z-yaml">
</span><span class="z-source z-yaml"><span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">volumes</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
</span><span class="z-source z-yaml">  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">wg-data</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
</span><span class="z-source z-yaml">
</span></code></pre>
<p>After saving any modification need to fit your network, save a new file named <code>.env</code> in the same directory as the compose file with the following contents.</p>
<pre class="z-code"><code><span class="z-text z-plain"># General linuxserver.io env vars
</span><span class="z-text z-plain">PGID=500
</span><span class="z-text z-plain">PUID=500
</span><span class="z-text z-plain">
</span><span class="z-text z-plain"># Required WireGuard container env vars
</span><span class="z-text z-plain">WG_PEER_LIST=thomas,emily
</span><span class="z-text z-plain">WG_INTERNAL_SUBNET=10.210.0.0
</span><span class="z-text z-plain">WG_PKA_PEER_LIST=
</span><span class="z-text z-plain">
</span><span class="z-text z-plain"># Optional WireGuard container env variables
</span><span class="z-text z-plain">#WG_SERVER_PORT=43210
</span><span class="z-text z-plain">
</span></code></pre>
<p>The <code>.env</code> file will be parsed when we invoke the <code>docker compose</code> command and the variable values will be injected into the resulting compose spec. Double-check the values in the <code>.env</code> file and invoke <code>docker compose -H ssh://core@&lt;train-station-ip&gt; -f docker-compose.yml up -d</code>. Here we use the <code>-H</code> flag to set the Docker endpoint to use. This will securely wrap all communication between the Docker daemon on the VPS and the Docker client we have installed locally. If this is the first time you have made an SSH connection to your VPS, the invocation will fail because the VPS's host key has not yet been trusted yet. The easiest way to fix the issue is to connect to the VPS of SSH before invoking the <code>docker compose</code> command. Now it's time for the grand opening of this <a rel="noopener nofollow" target="_blank" href="https://en.wikipedia.org/wiki/Shining_Time_Station">shining time station</a>!</p>
<h2 id="open-for-business">Open for Business</h2>
<p>Now that we have the operating system installed and the WireGuard server running in a container, we can begin to enjoy the fruits of our labor. My primary WireGuard use case is connecting back to services in my home lab from my phone while on the move. That sort of configuration is worthy of a post by itself, so for now we'll focus on getting an Android phone connected. The maintainers of the WireGuard project have really put in some work on this app. Start by opening the app and tapping the add button. Tap the <code>Scan from QR code</code> option. In your terminal, invoke the following <code>docker -H ssh://core@&lt;train-station-ip&gt; logs wireguard</code> and you should see a few QR codes (the config above configures 2 peers). Scan the code for <code>peer_thomas</code>. After a successful scan, you are prompted to name the tunnel. Keeping with the post's theme, I named the tunnel <code>train-station</code>. Finally, activate the tunnel by tapping the toggle button.</p>
<h2 id="next-stop-web-scale">Next Stop, WEB SCALE!</h2>
<p>Not really, this setup isn't built for that! As I stated before, the plan is to make some of my self-hosted services available over WireGuard, but that's a post for a different day. Thanks for reading!</p>

<p><b><a href="#">Back to top</a></b></p>
    </article>
  </main>
  <footer>
    <hr />
    <div class="c">
      <nav>
        <ul><li><a href="https://cskwrd.github.io/atom.xml" target="_blank" title="Atom/RSS Feed"><i type="Button" class="svg rss" title="Atom/RSS Feed"></i></a></li><li><a href="https://github.com/cskwrd/" target="_blank" title="Github"><i type="Button" class="svg github" title="Github"></i></a></li></ul>
      </nav>
      <p class="s90">Copyright &copy; 2024 A Blog</p>
      <nav>
        <ul></ul>
      </nav>
    </div>
  </footer>
<span class="topout">
<span class="topleft"> </span><a href="#" class="top" title="Back to Top"><i class="svgs svgh angu"></i></a>
</span>
</body>
</html>